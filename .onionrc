#!/usr/bin/env sh
# shellcheck disable=SC2034

## DESCRIPTION
## This file is the configuration for the tor menus and scripts.
## It contains functions which are used in several scripts.
## Hopefully, this way the scripts stay short and clear.
## Path for folders variables must not contain "/" at the end.
##
## SYNTAX
##  . .onionrc
##
## ADAPT
## For this, use 'sed', with '|' as delimiter and escape quoted variables with '\"', -i'' for compatibility.
## sed -i'' "s|VAR=.*|VAR=\"something\"|" .onionrc
##
###########################
######## VARIABLES ########

## [ EDIT REQUIRED ] (IF NOT DEBIAN)
tor_user="debian-tor" ## [debian-tor|tor]
tor_service="tor@default.service" ## [tor@default.service|tor.service]
pkg_mngr_install="sudo apt install -y" ## always use the 'yes' flag to be non interactive
web_server="nginx" ## [nginx|apache2]
dialog_box="dialog" ## [dialog|whiptail]
requirements="tor grep sed openssl basez git qrencode pandoc lynx gzip tar python3-stem ${dialog_box} ${web_server}" ## search pkg name for your OS on docs/COMPATIBILITY.md

## [ EDIT OPTIONAL ]
website_dir="/var/www"
## Vanguards - https://github.com/mikeperry-tor/vanguards/commits/master
vanguards_commit="10942de"
## Dialog
DIALOGRC="${ONIONSERVICE_PWD}/.dialogrc" ## ~/.dialogrc
## Backup
scp_target_user="remoteUser"
scp_target_ip="remoteIp"
scp_target_path="/home/${scp_target_user}/remote/path"
scp_target_full="${scp_target_user}@${scp_target_ip}:${scp_target_path}" ## '[USER]@[SERVER]:[SERVER_DIR]'
hs_bk_dir="${HOME}/tor-hs-backup"
local_dowload_path="${HOME}/tor-hs-backup"
local_ip=$(hostname -I | cut -d " " -f1) ## There is no posix way of handling network interfaces
## tor defaults
torrc_root="/etc/tor"
torrc="${torrc_root}/torrc"
data_dir="/var/lib/tor"
data_dir_services="${data_dir}/services"
data_dir_auth="${data_dir}/onion_auth"
control_port="9051" ## only the port, not the host

## [ TODO ] ## expectation is to automate onion-auth inclusion, but would  have to be more usable than the browser gui version
tor_browser_root="${HOME}/.local/share/torbrowser/tbb/$(uname -m)/tor-tor_browser_${LANG%.*}" ## this is where https://github.com/micahflee/torbrowser-launcher saves it
tor_browser_data_dir="${tor_browser_root}/Browser/TorBrowser/Data/Tor"
tor_browser_torrc="${tor_browser_data_dir}/torrc"
tor_browser_data_dir_auth="${tor_browser_data_dir}/onion-auth"

## [ COLORS ]
bold="1" ## [0|1]
bold="${bold:-0}" ## If bold is empty or unset, don't use bold
nocolor="\033[0m"
white="\033[${bold};97m"
black="\033[${bold};30m"
red="\033[${bold};31m"
green="\033[${bold};32m"
yellow="\033[${bold};33m"
blue="\033[${bold};34m"
magenta="\033[${bold};35m"
cyan="\033[${bold};36m"


###########################
######## FUNCTIONS ########

## install space separated list of packages (e.g.: install_package tor openssl git)
#command -v "${package}"
#type "${package}"
install_package(){
  for package in "${@}"; do
    command -v "${package}" >/dev/null || ${pkg_mngr_install} "${package}"
  done
}

## set correct permissions for tor directories and files
set_owner_permission(){
  sudo chown -R "${tor_user}:${tor_user}" "${data_dir}"
  sudo chmod 700 "${data_dir}"

  sudo chown -R root:root "${torrc_root}"
  sudo chmod 755 "${torrc_root}"
  sudo chmod 644 "${torrc}"
}


# This function reload tor by default or forces to restart
restarting_tor()
{
  set_owner_permission
  if [ "${1}" = "force" ]; then
    printf "\n# Restarting tor, please be patient.\n"
    printf "# Getting stuck after several minutes? Press Ctrl-C\n"
    printf "# and to restore the lastest torrc backup run:\n"
    printf "$ onionservice-cli setup torrc\n"
    sudo systemctl restart "${tor_service}"
    printf %s"${green}# Restarted tor succesfully!\n${nocolor}"
  elif [ -z "${1}" ]; then
    printf "\n# Reloading tor if active else will restart tor, please be patient.\n"
    printf "# Getting stuck after several minutes? Press Ctrl-C\n"
    printf "# and to restore the lastest torrc backup run:\n"
    printf "$ onionservice-cli setup torrc\n"
    sudo systemctl reload-or-restart "${tor_service}"
    printf %s"${green}# Reloaded tor succesfully!\n${nocolor}"
  fi
}
